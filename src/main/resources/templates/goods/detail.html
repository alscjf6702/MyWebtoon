<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <th:block th:replace="fragments/header :: header"/>
    <th:block th:replace="layouts/layout :: css"/>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <link rel="stylesheet" th:href="@{/css/goodsDetail.css}">

    <script>
        IMP.init('imp63736637');

    </script>


</head>
<body>

<div class="container" >
    <div class="imgContainer">
    <th:block th:if="${detail.fileName == null }">
    <img style="width:200px;height: auto;" src="/files/noImg.jpg">
    </th:block>
    <th:block th:if="${detail.fileName != null }">
        <img style="max-width: 500px; height: auto;" th:src="@{/files/{fileName}(fileName=${detail.fileName})}">
    </th:block>
    </div>

    <div class="infoContainer">

        ë¬¼í’ˆë²ˆí˜¸ : [[${detail.productId}]]<br><br>
        ë¬¼í’ˆëª… : [[${detail.productName}]]<br>
        ë¬¼í’ˆ ì„¤ëª… <br>[[${detail.productInfo}]]<br>
        <button class="border-0 bg-transparent" id="likeBtn" onclick="">ğŸ‘</button>
        <hr>
        íŒë§¤ê°€&nbsp;&nbsp;&nbsp;&nbsp;
        <span id="amount" th:text="${#numbers.formatInteger(detail.price,3,'COMMA')} + 'ì›'"/><br>
        íŒë§¤ì&nbsp;&nbsp;&nbsp;&nbsp;
        <th:block th:text="${detail.seller}"/>


        <hr>

        ì¬ê³  &nbsp;&nbsp;&nbsp;&nbsp; [[${detail.productsLeft}]]<br>
        êµ¬ë§¤ìˆ˜ëŸ‰ &nbsp;&nbsp;&nbsp;&nbsp;
        <label for="buyCount">
            <select name="buyCount" id="buyCount" >
                <option th:each="productsLeft :${#numbers.sequence(0,detail.productsLeft)}" th:value="${productsLeft}" th:text="${productsLeft}"></option>
            </select>
        </label>
        <hr>
        êµ¬ë§¤ìˆ˜ëŸ‰: <span id="buyCountText">0</span><br>
        ì´ ê°€ê²© : <span id="totalPrice">0ì›</span>

    </div>
    <form th:action="@{/goods/delete(id=${detail.id})}" method="post">
    <div sec:authorize="isAuthenticated()">
        <th:block th:if="${#authentication.principal.username == detail.seller}">
            <a class="btn btn-success float-end ms-2" th:href="@{/goods/productUpdate(id=${detail.id})}">ìƒí’ˆìˆ˜ì •</a>
        </th:block>
        <th:block th:if="${#authentication.principal.username == detail.seller || #authentication.principal.username == 'admin'}">
            <button type="submit" class="btn btn-danger float-end ms-2" onclick="return confirm('ìƒí’ˆì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ìƒí’ˆì‚­ì œ</button>
        </th:block>

    </div>
    <a th:href="@{/goods/list}" class="btn btn-success float-end">ìƒí’ˆëª©ë¡</a>
    <th:block sec:authorize="isAuthenticated()">
        <button type="button" class="btn btn-dark float-end me-2" onclick="payment()">êµ¬ë§¤í•˜ê¸°</button>
    </th:block>
    </form>

</div>


<script>


    document.getElementById("buyCount").addEventListener("change", function() {
        var buyCount = this.value; // ì„ íƒí•œ êµ¬ë§¤ìˆ˜ëŸ‰
        var price = parseInt([[${detail.price}]]); // íŒë§¤ê°€

        var totalPrice = buyCount * price; // ì´ ê°€ê²© ê³„ì‚°

        // ì´ ê°€ê²©ì„ 3ìë¦¬ ì½¤ë§ˆ í˜•íƒœë¡œ ë³€ê²½í•˜ì—¬ ì´ ê°€ê²© ì˜ì—­ì˜ í…ìŠ¤íŠ¸ë¡œ ì„¤ì •
        document.getElementById("totalPrice").innerText = totalPrice.toLocaleString() + 'ì›';

        // buyCount ì˜ì—­ì˜ í…ìŠ¤íŠ¸ë¡œ êµ¬ë§¤ìˆ˜ëŸ‰ ì„¤ì •
        document.getElementById("buyCountText").innerText = buyCount;

        updateTotalPriceForPayment(totalPrice);
    });

    function updateTotalPriceForPayment(totalPrice) {
        // ì—¬ê¸°ì„œ totalPrice ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ê²°ì œ ìš”ì²­ì„ ì—…ë°ì´íŠ¸
        console.log("ì´ ê°€ê²© : " + totalPrice);
    }


    function payment() {

        let uuid = self.crypto.randomUUID();    //uuidê°ì²´
        var productNumber = "[[${detail.productId}]]";  //ìƒí’ˆë²ˆí˜¸ ë¶ˆëŸ¬ì˜¤ê¸°
        var orderNum = uuid + "_"+ productNumber;   //merchant_uid ì— uuid ì§€ì •

        var productName = "[[${detail.productName}]]";  //ìƒí’ˆëª… ë¶ˆëŸ¬ì˜¤ê¸°

        var buyCount = parseInt(document.getElementById("buyCount").value); // ì„ íƒí•œ êµ¬ë§¤ìˆ˜ëŸ‰ì„ ìˆ«ìë¡œ ë³€í™˜
        var price = parseInt(document.getElementById("amount").innerText.replace(/,/g, '')); // íŒë§¤ê°€ë¥¼ ìˆ«ìë¡œ ë³€í™˜

        console.log("ì´ ê°€ê²© : " + totalPrice)
        var totalPrice = buyCount * price; // ì´ ê°€ê²© ê³„ì‚°

        console.log("ìƒí’ˆ ê°€ê²© : " + price)
        console.log("êµ¬ë§¤ìˆ˜ëŸ‰ : " + buyCount)

        if (totalPrice === 0) {
            alert("êµ¬ë§¤ ìˆ˜ëŸ‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")
        }

        IMP.request_pay({
            pg: 'danal_tpay',
            pay_method: 'card',
            merchant_uid: orderNum, // ìƒì ì—ì„œ ìƒì„±í•œ ê³ ìœ  ì£¼ë¬¸ë²ˆí˜¸
            name: productName,
            amount: totalPrice,
            // buyer_email: 'test@portone.io',
            // buyer_name: 'êµ¬ë§¤ìì´ë¦„',
            // buyer_tel: '010-1234-5678',
            // buyer_addr: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì‚¼ì„±ë™',
            // buyer_postcode: '123-456',
        }, function (rsp) {
            if (rsp.success) {
                console.log(rsp)
            } else {
                console.log(rsp)
            }
        });
    }


</script>

</body>
</html>